# Safety Co-pilot FastAPI

This directory contains a FastAPI backend that exposes analytics from the Streamlit app as HTTP endpoints.

## Quickstart

- Create and activate a virtual environment (recommended)
  - Windows (PowerShell):
    ```powershell
    python -m venv .venv
    .venv\\Scripts\\Activate.ps1
    ```
- Install dependencies from the project root:
  ```powershell
  pip install -r requirements.txt
  ```
- Run the API server from the project root:
  ```powershell
  uvicorn fastapiepcl.app.main:app --reload --port 8000
  ```
- Open the docs:
  - Swagger UI: http://127.0.0.1:8000/docs
  - ReDoc: http://127.0.0.1:8000/redoc

## Endpoints (auto data from app/EPCL_VEHS_Data_Processed.xlsx)

- GET `/health` â€“ Health check.

- Analytics (Plotly JSON):
  - GET `/analytics/hse-scorecard`
  - GET `/analytics/hse-performance-index?dataset=incident|hazard` (default incident)
  - GET `/analytics/risk-calendar-heatmap?dataset=incident|hazard`
  - GET `/analytics/psm-breakdown?dataset=incident|hazard`
  - GET `/analytics/consequence-matrix?dataset=incident|hazard`
  - GET `/analytics/data-quality-metrics?dataset=incident|hazard`
  - GET `/analytics/comprehensive-timeline?dataset=incident|hazard`
  - GET `/analytics/audit-inspection-tracker`
  - GET `/analytics/location-risk-treemap?dataset=incident|hazard`
  - GET `/analytics/department-spider?dataset=incident|hazard`
  - GET `/analytics/violation-analysis?dataset=incident|hazard` (default hazard)
  - GET `/analytics/cost-prediction-analysis?dataset=incident|hazard`
  - GET `/analytics/facility-layout-heatmap`
  - GET `/analytics/facility-3d-heatmap?dataset=incident|hazard&event_type=Incidents`

- Conversion analytics (auto-loads incidents and hazards):
  - GET `/analytics/conversion/funnel`
  - GET `/analytics/conversion/time-lag`
  - GET `/analytics/conversion/sankey`
  - GET `/analytics/conversion/department-matrix`
  - GET `/analytics/conversion/risk-network`
  - GET `/analytics/conversion/prevention-effectiveness`
  - GET `/analytics/conversion/metrics-gauge`

- Wordclouds:
  - GET `/wordclouds/departments?top_n=50&min_count=1&extra_stopwords=na,misc`

- Maps:
  - GET `/maps/combined`
  - GET `/maps/single?dataset=incident|hazard`

- Agent (LLM data assistant):
  - GET `/agent/run?question=...&dataset=incident|hazard|audit|inspection|all&model=gpt-4o`
    - Returns code generated by the LLM, a preview of results, optional Plotly figure JSON or a base64 PNG for Matplotlib, stdout/stderr, and a prescriptive analysis.

## Notes

- CORS is open by default for local development. Restrict `allow_origins` in `fastapiepcl/app/main.py` for production.
- Place your Excel file at `fastapiepcl/app/EPCL_VEHS_Data_Processed.xlsx`. The server auto-loads and caches it on first request. If you replace the file while the server is running, restart the server to reload.
- The backend imports functions from the root `analytics/` package and expects to be run with the project root as the working directory.
- If Folium or optional dependencies are missing, ensure you installed `requirements.txt` from the project root.
- For the Agent endpoints, set your OpenAI API key as an environment variable before starting the server:
  ```powershell
  $env:OPENAI_API_KEY = "sk-..."
  ```
  The agent executes small, LLM-generated pandas code in a restricted sandbox with minimal builtins and no network or filesystem access.

## Project structure

```
fastapiepcl/
  app/
    main.py
    models/
      schemas.py
    routers/
      workbooks.py
      wordclouds.py
      maps.py
      analytics_general.py
      analytics_conversion.py
    services/
      excel.py
      schema.py
      analytics_general.py
      plots.py
    EPCL_VEHS_Data_Processed.xlsx
```

